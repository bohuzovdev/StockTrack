<!DOCTYPE html>
<html>
<head>
    <title>StockTrack Client-Side Crypto Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .test-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        input, button { padding: 8px; margin: 5px; }
        input[type="text"] { width: 300px; }
        button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 4px; word-break: break-all; }
        .crypto-info { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 StockTrack Client-Side Encryption Test</h1>
        
        <div class="crypto-info">
            <strong>🛡️ Crypto Support Status:</strong>
            <span id="crypto-support">Checking...</span>
        </div>
        
        <div class="test-section">
            <h3>🧪 Interactive Token Encryption Test</h3>
            <p>Enter a test token to see encryption/decryption in action:</p>
            
            <input type="text" id="test-token" placeholder="Enter your test token here..." value="test_monobank_token_12345!@#">
            <br>
            <button onclick="testEncryption()">🔐 Encrypt & Decrypt</button>
            <button onclick="clearResults()">🗑️ Clear Results</button>
            
            <div id="encryption-results"></div>
        </div>
        
        <div class="test-section">
            <h3>📊 Automated Test Suite</h3>
            <button onclick="runAllTests()">🚀 Run All Tests</button>
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>🔧 SecureStorage Test</h3>
            <input type="text" id="storage-key" placeholder="Storage key" value="test_key">
            <input type="text" id="storage-value" placeholder="Value to store" value="secret_value_123">
            <br>
            <button onclick="testSecureStorage()">💾 Test Secure Storage</button>
            <div id="storage-results"></div>
        </div>
    </div>

    <script>
        // Copy the crypto functions from the client lib
        const ALGORITHM = 'AES-GCM';
        const KEY_LENGTH = 256;
        const IV_LENGTH = 12;

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );

            return window.crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256',
                },
                keyMaterial,
                { name: ALGORITHM, length: KEY_LENGTH },
                false,
                ['encrypt', 'decrypt']
            );
        }

        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx?.beginPath();
            ctx?.arc(50, 50, 20, 0, 2 * Math.PI);
            ctx?.stroke();
            
            const canvasFingerprint = canvas.toDataURL();
            const screenFingerprint = `${screen.width}x${screen.height}x${screen.colorDepth}`;
            const timezoneFingerprint = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const languageFingerprint = navigator.language;
            const userAgentFingerprint = navigator.userAgent.slice(0, 100);
            
            return `${canvasFingerprint}-${screenFingerprint}-${timezoneFingerprint}-${languageFingerprint}-${userAgentFingerprint}`;
        }

        async function encryptToken(token) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(token);
                
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(IV_LENGTH));
                
                const deviceFingerprint = generateDeviceFingerprint();
                const key = await deriveKey(deviceFingerprint, salt);
                
                const encrypted = await window.crypto.subtle.encrypt(
                    {
                        name: ALGORITHM,
                        iv: iv,
                    },
                    key,
                    data
                );
                
                const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encrypted), salt.length + iv.length);
                
                return btoa(String.fromCharCode(...Array.from(combined)));
            } catch (error) {
                console.error('Encryption failed:', error);
                return btoa(token);
            }
        }

        async function decryptToken(encryptedToken) {
            try {
                const combined = new Uint8Array(
                    atob(encryptedToken)
                        .split('')
                        .map(char => char.charCodeAt(0))
                );
                
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 16 + IV_LENGTH);
                const encrypted = combined.slice(16 + IV_LENGTH);
                
                const deviceFingerprint = generateDeviceFingerprint();
                const key = await deriveKey(deviceFingerprint, salt);
                
                const decrypted = await window.crypto.subtle.decrypt(
                    {
                        name: ALGORITHM,
                        iv: iv,
                    },
                    key,
                    encrypted
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (error) {
                console.error('Decryption failed:', error);
                try {
                    return atob(encryptedToken);
                } catch {
                    throw new Error('Failed to decrypt token');
                }
            }
        }

        class SecureStorage {
            static prefix = 'stocktrack_secure_';
            
            static async setItem(key, value) {
                try {
                    const encrypted = await encryptToken(value);
                    const storageKey = this.prefix + key;
                    localStorage.setItem(storageKey, encrypted);
                } catch (error) {
                    console.error('Secure storage set failed:', error);
                    throw new Error('Failed to securely store token');
                }
            }
            
            static async getItem(key) {
                try {
                    const storageKey = this.prefix + key;
                    const encrypted = localStorage.getItem(storageKey);
                    if (!encrypted) return null;
                    
                    return await decryptToken(encrypted);
                } catch (error) {
                    console.error('Secure storage get failed:', error);
                    this.removeItem(key);
                    return null;
                }
            }
            
            static removeItem(key) {
                const storageKey = this.prefix + key;
                localStorage.removeItem(storageKey);
            }
        }

        function isCryptoSupported() {
            return !!(window.crypto && window.crypto.subtle);
        }

        // Check crypto support on load
        window.addEventListener('load', () => {
            const supportEl = document.getElementById('crypto-support');
            const supported = isCryptoSupported();
            
            if (supported) {
                supportEl.innerHTML = '<span class="success">✅ Web Crypto API Available</span>';
            } else {
                supportEl.innerHTML = '<span class="error">❌ Web Crypto API Not Available</span>';
            }
        });

        async function testEncryption() {
            const token = document.getElementById('test-token').value;
            const resultsEl = document.getElementById('encryption-results');
            
            if (!token) {
                resultsEl.innerHTML = '<div class="error">Please enter a token to test!</div>';
                return;
            }
            
            try {
                resultsEl.innerHTML = '<div class="info">🔄 Testing encryption...</div>';
                
                const startTime = performance.now();
                
                // Test encryption
                const encrypted = await encryptToken(token);
                const encryptTime = performance.now();
                
                // Test decryption
                const decrypted = await decryptToken(encrypted);
                const decryptTime = performance.now();
                
                const success = token === decrypted;
                
                const results = `
                    <div class="result">
                        <strong>📝 Original Token:</strong> ${token}<br>
                        <strong>🔐 Encrypted (${encrypted.length} chars):</strong> ${encrypted.substring(0, 100)}...<br>
                        <strong>🔓 Decrypted:</strong> ${decrypted}<br>
                        <strong>✅ Match:</strong> <span class="${success ? 'success' : 'error'}">${success ? 'SUCCESS' : 'FAILED'}</span><br>
                        <strong>⏱️ Encryption Time:</strong> ${(encryptTime - startTime).toFixed(2)}ms<br>
                        <strong>⏱️ Decryption Time:</strong> ${(decryptTime - encryptTime).toFixed(2)}ms<br>
                        <strong>🔍 Device Fingerprint Hash:</strong> ${generateDeviceFingerprint().substring(0, 50)}...
                    </div>
                `;
                
                resultsEl.innerHTML = results;
            } catch (error) {
                resultsEl.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }

        async function runAllTests() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '<div class="info">🔄 Running automated tests...</div>';
            
            const testTokens = [
                'simple_token',
                'complex_token_with_123_and_special!@#',
                'very_long_token_that_might_be_used_in_production_environments_with_numbers_123_and_special_chars!@#$%',
                '🔑 unicode token with emoji 🚀',
                ''
            ];
            
            let results = '<h4>🧪 Automated Test Results:</h4>';
            let allPassed = true;
            
            for (let i = 0; i < testTokens.length; i++) {
                const token = testTokens[i];
                const displayToken = token || '(empty string)';
                
                try {
                    const encrypted = await encryptToken(token);
                    const decrypted = await decryptToken(encrypted);
                    const success = token === decrypted;
                    
                    if (!success) allPassed = false;
                    
                    results += `
                        <div class="result">
                            <strong>Test ${i + 1}:</strong> "${displayToken.substring(0, 30)}..."<br>
                            <strong>Result:</strong> <span class="${success ? 'success' : 'error'}">${success ? '✅ PASS' : '❌ FAIL'}</span><br>
                            <strong>Encrypted Length:</strong> ${encrypted.length} characters
                        </div>
                    `;
                } catch (error) {
                    allPassed = false;
                    results += `
                        <div class="result">
                            <strong>Test ${i + 1}:</strong> "${displayToken.substring(0, 30)}..."<br>
                            <strong>Result:</strong> <span class="error">❌ ERROR: ${error.message}</span>
                        </div>
                    `;
                }
            }
            
            results += `
                <div class="result">
                    <strong>🏆 Overall Result:</strong> 
                    <span class="${allPassed ? 'success' : 'error'}">
                        ${allPassed ? '🎉 All tests passed!' : '💥 Some tests failed!'}
                    </span>
                </div>
            `;
            
            resultsEl.innerHTML = results;
        }

        async function testSecureStorage() {
            const key = document.getElementById('storage-key').value;
            const value = document.getElementById('storage-value').value;
            const resultsEl = document.getElementById('storage-results');
            
            if (!key || !value) {
                resultsEl.innerHTML = '<div class="error">Please enter both key and value!</div>';
                return;
            }
            
            try {
                resultsEl.innerHTML = '<div class="info">🔄 Testing secure storage...</div>';
                
                // Store value
                await SecureStorage.setItem(key, value);
                
                // Check localStorage
                const encryptedInStorage = localStorage.getItem('stocktrack_secure_' + key);
                
                // Retrieve value
                const retrieved = await SecureStorage.getItem(key);
                
                const success = value === retrieved;
                
                const results = `
                    <div class="result">
                        <strong>🔑 Storage Key:</strong> ${key}<br>
                        <strong>📝 Original Value:</strong> ${value}<br>
                        <strong>🔐 Encrypted in localStorage:</strong> ${encryptedInStorage ? encryptedInStorage.substring(0, 100) + '...' : 'null'}<br>
                        <strong>🔓 Retrieved Value:</strong> ${retrieved}<br>
                        <strong>✅ Match:</strong> <span class="${success ? 'success' : 'error'}">${success ? 'SUCCESS' : 'FAILED'}</span><br>
                        <strong>📊 Storage Size:</strong> ${encryptedInStorage ? encryptedInStorage.length : 0} characters
                    </div>
                `;
                
                resultsEl.innerHTML = results;
                
                // Clean up
                SecureStorage.removeItem(key);
            } catch (error) {
                resultsEl.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }

        function clearResults() {
            document.getElementById('encryption-results').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('storage-results').innerHTML = '';
        }
    </script>
</body>
</html> 